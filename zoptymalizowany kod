#include <iostream>
#include <fstream>
#include <vector>
#include <string>
#include <algorithm>
#include <chrono>
#include <utility>
#include <iomanip>
#include <sstream>

using namespace std;

// Funkcja do znajdowania największej liczby przez połączenie elementów
string znajdzNajwiekszaLiczbe(vector<int>& liczby) {
    // Cache'owanie wyników to_string
    vector<pair<string, int>> liczby_str;
    for (int liczba : liczby) {
        liczby_str.emplace_back(to_string(liczba), liczba);
    }

    // Sortowanie z wykorzystaniem cache'u
    sort(liczby_str.begin(), liczby_str.end(), [](const pair<string, int>& a, const pair<string, int>& b) {
        return a.first + b.first > b.first + a.first;
    });

    // Konstrukcja wyniku
    string wynik;
    for (const auto& p : liczby_str) {
        wynik += p.first;
    }

    return wynik;
}

// Funkcja do wczytywania danych z pliku
vector<int> wczytajDane(const string& nazwaPliku) {
    ifstream plik(nazwaPliku);
    vector<int> liczby;
    int liczba;

    if (plik.is_open()) {
        while (plik >> liczba) {
            liczby.push_back(liczba);
        }
        plik.close();
    } else {
        cerr << "Nie udało się otworzyć pliku: " << nazwaPliku << endl;
    }

    return liczby;
}

// Funkcja do formatowania czasu z dynamiczną precyzją
string sformatujCzas(double czasWykonania) {
    ostringstream oss;
    if (czasWykonania < 0.001) {
        oss << fixed << setprecision(9);
    } else {
        oss << fixed << setprecision(6);
    }
    oss << czasWykonania;
    return oss.str();
}

// Funkcja do zapisu wyniku do pliku
void zapiszWynik(const string& nazwaPliku, const string& wynik, double czasWykonania, const vector<int>& daneWejsciowe) {
    ofstream plik(nazwaPliku, ios::app);

    if (plik.is_open()) {
        auto teraz = chrono::system_clock::now();
        time_t czas = chrono::system_clock::to_time_t(teraz);

        plik << "Dane wejściowe: ";
        for (int liczba : daneWejsciowe) {
            plik << liczba << " ";
        }
        plik << endl;

        plik << "Wynik: " << wynik << endl;
        plik << "Czas wykonania: " << sformatujCzas(czasWykonania) << " sekundy" << endl;
        plik << "Data i godzina: " << ctime(&czas);
        plik << "-------------------------------" << endl;

        plik.close();
    } else {
        cerr << "Nie udało się zapisać wyników do pliku: " << nazwaPliku << endl;
    }
}

int main() {
    // Wczytywanie danych z pliku
    string plikWejsciowy = "dane.txt";
    string plikWyjsciowy = "wynik.txt";
    vector<int> liczby = wczytajDane(plikWejsciowy);

    if (liczby.empty()) {
        cerr << "Brak danych wejściowych" << endl;
        return 1;
    }

    // Wyświetlenie danych wejściowych
    cout << "Dane wejściowe: ";
    for (int liczba : liczby) {
        cout << liczba << " ";
    }
    cout << endl;

    // Pomiar czasu wykonania algorytmu
    auto start = chrono::high_resolution_clock::now();
    string wynik = znajdzNajwiekszaLiczbe(liczby);
    auto end = chrono::high_resolution_clock::now();

    chrono::duration<double> czasWykonania = end - start;

    // Wyświetlenie wyniku
    cout << "Największa możliwa liczba: " << wynik << endl;
    cout << "Czas wykonania: " << sformatujCzas(czasWykonania.count()) << " sekundy" << endl;

    // Zapis wyniku do pliku
    zapiszWynik(plikWyjsciowy, wynik, czasWykonania.count(), liczby);

    return 0;
}
